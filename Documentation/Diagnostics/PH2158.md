# PH2158: Avoid PKCS#1 v1.5 padding with RSA encryption

| Property | Value  |
|--|--|
| Package | [Philips.CodeAnalysis.SecurityAnalyzers](https://www.nuget.org/packages/Philips.CodeAnalysis.SecurityAnalyzers) |
| Diagnostic ID | PH2158 |
| Category  | [Security](../Security.md) |
| Analyzer | [AvoidPkcsPaddingWithRsaEncryptionAnalyzer](https://github.com/philips-software/roslyn-analyzers/blob/main/Philips.CodeAnalysis.SecurityAnalyzers/AvoidPkcsPaddingWithRsaEncryptionAnalyzer.cs)
| CodeFix  | Yes |
| Severity | Error |
| Enabled By Default | No |

## Introduction

This rule identifies usage of PKCS#1 v1.5 padding with RSA encryption, which is vulnerable to padding oracle attacks.

## Reason

PKCS#1 v1.5 padding is susceptible to padding oracle attacks that can allow attackers to decrypt encrypted data or forge signatures. OAEP (Optimal Asymmetric Encryption Padding) provides significantly better security through a more robust padding scheme that includes randomness and cryptographic hashing.

## How to fix violations

Replace `RSAEncryptionPadding.Pkcs1` with `RSAEncryptionPadding.OaepSHA256` or other OAEP variants. The CodeFix provider will automatically suggest replacing `.Pkcs1` with `.OaepSHA256`.

## Examples

### Incorrect

```csharp
using System.Security.Cryptography;

class Example
{
    void EncryptData(RSA rsa, byte[] data)
    {
        // This triggers PH2158 - PKCS#1 v1.5 padding is insecure
        byte[] encrypted = rsa.Encrypt(data, RSAEncryptionPadding.Pkcs1);
    }
    
    void DecryptData(RSA rsa, byte[] encryptedData)
    {
        // This also triggers PH2158
        byte[] decrypted = rsa.Decrypt(encryptedData, RSAEncryptionPadding.Pkcs1);
    }
    
    void AssignPadding()
    {
        // This also triggers PH2158
        RSAEncryptionPadding padding = RSAEncryptionPadding.Pkcs1;
    }
}
```

### Correct

```csharp
using System.Security.Cryptography;

class Example
{
    void EncryptData(RSA rsa, byte[] data)
    {
        // Use OAEP padding for better security
        byte[] encrypted = rsa.Encrypt(data, RSAEncryptionPadding.OaepSHA256);
    }
    
    void DecryptData(RSA rsa, byte[] encryptedData)
    {
        // Use OAEP padding for better security
        byte[] decrypted = rsa.Decrypt(encryptedData, RSAEncryptionPadding.OaepSHA256);
    }
    
    void AssignPadding()
    {
        // Use OAEP padding for better security
        RSAEncryptionPadding padding = RSAEncryptionPadding.OaepSHA256;
    }
}
```

## Configuration

This rule is disabled by default and must be explicitly enabled in your project configuration.

## Suppression

```csharp
[SuppressMessage("Philips.CodeAnalysis.SecurityAnalyzers", "PH2158:Avoid PKCS#1 v1.5 padding with RSA encryption", Justification = "Reviewed.")]
```

## References

- [OAEP Padding](https://en.wikipedia.org/wiki/Optimal_asymmetric_encryption_padding)
- [Padding Oracle Attacks](https://en.wikipedia.org/wiki/Padding_oracle_attack)
- [RSAEncryptionPadding Class](https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rsaencryptionpadding)