# PH2155: Avoid Packages with Unacceptable Licenses

| Property | Value  |
|--|--|
| Package | [Philips.CodeAnalysis.SecurityAnalyzers](https://www.nuget.org/packages/Philips.CodeAnalysis.SecurityAnalyzers) |
| Diagnostic ID | PH2155 |
| Category  | [Security](../Security.md) |
| Analyzer | [LicenseAnalyzer](https://github.com/philips-software/roslyn-analyzers/blob/main/Philips.CodeAnalysis.SecurityAnalyzers/LicenseAnalyzer.cs)
| CodeFix  | No |
| Severity | Info |
| Enabled By Default | No |

## Introduction

This rule identifies packages with unacceptable licenses that may pose compliance risks to your project.

## Reason

Packages with unacceptable licenses, particularly copyleft licenses like GPL, can impose legal obligations on your project. These licenses may require you to open-source your entire project or comply with specific distribution terms. It's important to review and approve such dependencies before including them in your codebase.

## How to fix violations

1. **Review the package license**: Examine whether the license is truly incompatible with your project's requirements
2. **Find alternatives**: Look for packages with more permissive licenses (MIT, BSD, Apache-2.0)
3. **Add to allowed list**: If the license is acceptable for your use case, add it to the `Allowed.Licenses.txt` configuration file
4. **Remove the package**: If no suitable alternative exists and the license is unacceptable, remove the package dependency

## Examples

### Package with unacceptable license

```xml
<!-- This package reference might trigger PH2155 if it has a GPL license -->
<PackageReference Include="SomeGplPackage" Version="1.0.0" />
```

### Diagnostic message

```
Package 'SomeGplPackage' version '1.0.0' has an unacceptable license 'GPL-3.0'. Consider adding to Allowed.Licenses.txt if license is acceptable.
```

### Resolution options

#### Option 1: Add to allowed licenses file

```xml
<!-- In your project file -->
<ItemGroup>
  <AdditionalFiles Include="Allowed.Licenses.txt" />
</ItemGroup>
```

```text
# Allowed.Licenses.txt - Add acceptable licenses to this file
MIT
BSD-2-Clause
BSD-3-Clause
Apache-2.0
# Commercial license for specific vendor
CommercialLicense-Vendor-X
# Allow GPL for this specific use case
GPL-3.0
```

#### Option 2: Find alternative package

Replace the package with one that has a more permissive license:

```xml
<!-- Replace with alternative package -->
<PackageReference Include="AlternativePackage" Version="2.0.0" />
```

#### Option 3: Remove the dependency

If the package is not essential, remove it entirely:

```xml
<!-- Remove the problematic dependency -->
<!-- <PackageReference Include="SomeGplPackage" Version="1.0.0" /> -->
```

## How the Analyzer Works

The LicenseAnalyzer implements a sophisticated offline package license checking system that analyzes your project's NuGet dependencies without requiring network access:

### Architecture

1. **Project Discovery**: Uses `AnalyzerConfigOptionsProvider` to locate your project's `project.assets.json` file
2. **Package Analysis**: Parses the lock file using custom JSON parsing to extract all PackageReference dependencies  
3. **License Extraction**: Examines the local NuGet global packages cache to read `.nuspec` files and extract license information
4. **Performance Caching**: Builds and maintains a `licenses.cache` file to cache license information and avoid repeated file system operations
5. **Offline Operation**: Works entirely offline using your local NuGet cache without requiring network calls

### License Detection

The analyzer can detect licenses from multiple sources:
- **SPDX expressions**: Reads modern `<license type="expression">` elements from .nuspec files
- **License URLs**: Parses older `<licenseUrl>` elements and extracts license types from common URL patterns
- **Fallback identification**: Recognizes common licenses like MIT, Apache-2.0, BSD, GPL, LGPL from URLs

### Default Acceptable Licenses

The analyzer includes these permissive licenses as acceptable by default:
- MIT
- Apache-2.0  
- BSD-2-Clause
- BSD-3-Clause
- ISC
- Unlicense
- 0BSD

## Configuration

This analyzer is **disabled by default** and must be explicitly enabled. You can enable it in your project file or through analyzer configuration.

Configure allowed licenses by creating an `Allowed.Licenses.txt` file in your project and adding it as an additional file:

```xml
<ItemGroup>
  <AdditionalFiles Include="Allowed.Licenses.txt" />
</ItemGroup>
```

The `Allowed.Licenses.txt` file supports:
- One license identifier per line
- Comments using `#` at the beginning of lines
- Custom license names for commercial or proprietary packages
- SPDX license identifiers

## Performance

The analyzer includes several performance optimizations:

### License Caching
- Creates a `licenses.cache` file in your project directory to cache license information
- Avoids repeated parsing of `.nuspec` files for the same packages
- Cache persists across builds for improved performance

### Offline Operation
- No network calls required - works entirely with local NuGet cache
- Leverages the existing `~/.nuget/packages` global packages folder
- Uses `project.assets.json` for accurate dependency information

### Graceful Degradation
- Handles missing dependencies (like NuGet.ProjectModel) gracefully in analyzer environments
- Skips analysis if `project.assets.json` cannot be located
- Continues operation even if individual package licenses cannot be determined

## Limitations

- Requires `project.assets.json` to be present (generated after `dotnet restore`)
- Depends on packages being available in the local NuGet global packages cache
- Some license detection relies on parsing `.nuspec` files and may not catch all license formats
- Currently disabled by default and must be explicitly enabled

